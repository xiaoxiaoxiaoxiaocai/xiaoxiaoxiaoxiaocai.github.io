## 工具

### Matplotlib Pyplot

Pyplot 是matplotlib的子库。

Pyplot 包含一系列绘图函数的相关函数，每个函数会对当前的图像进行一些修改，例如：给图像加上标记，生新的图像，在图像中产生新的绘图区域等等。

```py
import matplotlib.pyplot as plt
```

引入pyplot库 ，设置别名为plt。

- `plot()`：用于绘制线图和散点图
- `scatter()`：用于绘制散点图
- `bar()`：用于绘制垂直条形图和水平条形图
- `hist()`：用于绘制直方图
- `pie()`：用于绘制饼图
- `imshow()`：用于绘制图像
- `subplots()`：用于创建子图

```py
# 画单条线
plot([x], y, [fmt], *, data=None, **kwargs)
# 画多条线
plot([x], y, [fmt], [x2], y2, [fmt2], ..., **kwargs)
```

```py
 plot(x, y)     # 创建 y 中数据与 x 中对应值的二维线图，使用默认样式
 plot(x, y, 'bo') # 创建 y 中数据与 x 中对应值的二维线图，使用蓝色实心圈绘制
 plot(y)      # x 的值为 0..N-1
 plot(y, 'r+')   # 使用红色 + 号
```

**颜色字符：**'b' 蓝色，'m' 洋红色，'g' 绿色，'y' 黄色，'r' 红色，'k' 黑色，'w' 白色，'c' 青绿色，'#008000' RGB 颜色符串。多条曲线不指定颜色时，会自动选择不同颜色。

**线型参数：**'‐' 实线，'‐‐' 破折线，'‐.' 点划线，':' 虚线。

**标记字符：**'.' 点标记，',' 像素标记(极小点)，'o' 实心圈标记，'v' 倒三角标记，'^' 上三角标记，'>' 右三角标记，'<' 左三角标记...等等。



绘制直线时

```py
import matplotlib.pyplot as plt
import numpy as np # 引入多维数组
x=np.array([0,6])
y=np.array([0,100])
plt.plot(x,y)
plt.show
```

只想绘制两个点

```py
import matplotlib.pyplot as plt
import numpy as np # 引入多维数组
x=np.array([0,6])
y=np.array([0,100])
plt.plot(x,y，'o')
plt.show
```

如果不指定x的值，那么将会根据y的值来设置

我们可以使用 pyplot 中的 grid() 方法来设置图表中的网格线。

```python
matplotlib.pyplot.grid(b=None, which='major', axis='both', )
//b：可选，默认为 None，可以设置布尔值，true 为显示网格线，false 为不显示，如果设置 kwargs 参数，则值为 true。
```



```text
标题和轴标签

        设置图片标题：

plt.title("标题", fontsize=12, loc="center")//loc:left, right, center
        设置轴标签：

plt.xlabel("x轴标题", fontsize=12, loc="left")//loc: left, right, center
plt.ylabel("y轴标题", fontsize=12, loc="top")//loc: top, bottom, center


设置横坐标轴刻度范围：plt.xticks(ticks, labels, rotation=90, fontsize=12)
设置纵坐标轴刻度范围：plt.yticks(ticks, labels, rotation=90, fontsize=12)
```

#### 绘制多图

**subplot()** 方法在绘图时需要指定位置，**subplots()** 方法可以一次生成多个，在调用时只需要调用生成对象的 ax 即可。

```py
import matplotlib.pyplot as plt
import numpy as np

#plot 1:
xpoints = np.array([0, 6])
ypoints = np.array([0, 100])

plt.subplot(1, 2, 1)
plt.plot(xpoints,ypoints)
plt.title("plot 1")

#plot 2:
x = np.array([1, 2, 3, 4])
y = np.array([1, 4, 9, 16])

plt.subplot(1, 2, 2)
plt.plot(x,y)
plt.title("plot 2")

plt.suptitle("RUNOOB subplot Test")
plt.show()
```

subplots()

```py
matplotlib.pyplot.subplots(nrows=1, ncols=1, *, sharex=False, sharey=False, squeeze=True, subplot_kw=None, gridspec_kw=None, fig_kw)
```

- **nrows**：默认为 1，设置图表的行数。
- **ncols**：默认为 1，设置图表的列数。
- **sharex、sharey**：设置 x、y 轴是否共享属性，默认为 false，可设置为 'none'、'all'、'row' 或 'col'。 False 或 none 每个子图的 x 轴或 y 轴都是独立的，True 或 'all'：所有子图共享 x 轴或 y 轴，'row' 设置每个子图行共享一个 x 轴或 y 轴，'col'：设置每个子图列共享一个 x 轴或 y 轴。
- **squeeze**：布尔值，默认为 True，表示额外的维度从返回的 Axes(轴)对象中挤出，对于 N*1 或 1*N 个子图，返回一个 1 维数组，对于 N*M，N>1 和 M>1 返回一个 2 维数组。如果设置为 False，则不进行挤压操作，返回一个元素为 Axes 实例的2维数组，即使它最终是1x1。
- **subplot_kw**：可选，字典类型。把字典的关键字传递给 add_subplot() 来创建每个子图。
- **gridspec_kw**：可选，字典类型。把字典的关键字传递给 GridSpec 构造函数创建子图放在网格里(grid)。
- ***\*fig_kw**：把详细的关键字参数传给 figure() 函数。

```
import matplotlib.pyplot as plt
import numpy as np
# 创建一个2x2的子图
fig, axs = plt.subplots(nrows=2, ncols=2)
 
# 在第一个子图中绘制正弦函数
x = np.linspace(0, 10, 100)
y1 = np.sin(x)
axs[0, 0].plot(x, y1)
axs[0, 0].set_title('Sin(x)')
 
# 在第二个子图中绘制余弦函数
y2 = np.cos(x)
axs[0, 1].plot(x, y2)
axs[0, 1].set_title('Cos(x)')
 
# 在第三个子图中绘制正切函数
y3 = np.tan(x)
axs[1, 0].plot(x, y3)
axs[1, 0].set_title('Tan(x)')
 
# 在第四个子图中绘制正切函数的导数
y4 = 1 / np.cos(x) ** 2
axs[1, 1].plot(x, y4)
axs[1, 1].set_title('Tan\'(x)')
# 调整布局以及子图之间的间距
plt.tight_layout()
# 显示图形
plt.show()
//
第 8~13 行在第一个子图 axs[0,0] 中绘制正弦函数，同时设置了标题为 ‘Sin(x)’。

第 16~21 行在第二个子图 axs[0,1] 中绘制余弦函数，同时设置了标题为 ‘Cos(x)’。

第 24~29 行在第三个子图 axs[1,0] 中绘制正切函数，同时设置了标题为 ‘Tan(x)’。

第 32~37 行在第四个子图 axs[1,1] 中绘制正切函数的导数，同时设置了标题为 ‘Tan’(x)'。
```



#### 散点图

可以用plot或scatter

```python
import numpy as np
import matplotlib.pyplot as plt

height=[160,170,175,186]
weight=[49,50,55,58]
plt.scatter(heigth,weight)   #将x和y的数据变成列表
plt.show()
```

#### 折线图

```py
import numpy as np
import matplotlib.pyplot as plt

x=np.linspace(-10,10,100) #从-10到10，等区间分成100份
y=x**2
plt.plot(x,y)
plt.show()


import matplotlib.pyplot as plt
import numpy as np 
x=np.array([1,0,2,6])
y=np.array([0,100,12,2])
plt.plot(x,y)
plt.show()
```

#### 条形图

```py
import numpy as np
import matplotlib.pyplot as plt

#------绘制单变量条形图------
n=5
y=[10,20,40,50，60]
index=np.arrage(n)
pl=plt.bar(left=index,height=y,color='red',width=0.5)  #left表示横坐标从0到5，高度为y，颜色为红色，宽度为0.5
pl=plt.bar(left=0,bottow=index,width=y,color='red',height=0.5,orientation='horizontal')  #left表示横坐标，bottow表示纵坐标，width表示宽度，颜色为红色，高度为0.5，方向为水平方向
plt.show()

#多变量条形图
sales_BJ=[50,55,63,69]
sales_SH=[45,56,58,66]

#绘制并列式的条形图
plt.bar(left=index,height=sales_BJ,colors='red')
plt.bar(left=index+barwidth,height=sales_SH,colors='blue')  
plt.show()


```

#### 直方图

```py
import numpy as np
import matplotlib.pyplot as plt

#-------绘制单变量直方图-------
x=100+no.random.randon(2000)  #x是2000个以100为均值的随机数据
plt.hist(x,bins=10，normed=True)   #bins表示共有10个直方块,normed表示是否需要标准化数据
plt.show()

#-------绘制双变量直方图-------
x=np.random.randon(2000)+2
y=np.random.randon(2000)+3
plt.hist2d(x,y,bins=40)   #用颜色深浅表示频率的大小
plt.show()


```

#### 饼状图

```py
import numpy as np
import matplotlib.pyplot as plt

labels='A','B','C','D'
fracs=[15,30,45,10]
explode=[0,0.05,0,0]   #标签为B的饼块将会离开圆心0.05个距离单位
plt.axes(aspect=1)   #绘制正圆
plt.pie(x=fracs,labels=labels,autopct='%.0f%%',explode=explode,shadow=True)  #autopct表示数据将会精确到小数点后一位，expolde表示希望着重表示哪一块，shadow表示是否需要添加阴影显得更好看
plt.show()


```

#### imshow（）

imshow() 函数是 Matplotlib 库中的一个函数，用于显示图像。

imshow() 函数常用于绘制二维的灰度图像或彩色图像。

imshow() 函数可用于绘制矩阵、热力图、地图等。



```py
imshow(X, cmap=None, norm=None, aspect=None, interpolation=None, alpha=None, vmin=None, vmax=None, origin=None, extent=None, shape=None, filternorm=1, filterrad=4.0, imlim=None, resample=None, url=None, *, data=None, kwargs)
```

```
绘画矩阵
x = [[1,2],[3,4]]
plt.imshow(x, cmap=plt.cm.gray, alpha=0.5)
plt.text(0, 0, "TP")
plt.text(0, 1, "FP")
plt.text(1, 0, "FN")
plt.text(1, 1, "TN")
plt.xlabel("prediction")
plt.ylabel("label")
plt.xticks([0, 1], ["true", "false"])
plt.yticks([0, 1], ["true", "false"])
//生成与x的形状相同的方块矩阵，与x的内部值没关系，只与其形状有关系
//alpha设置透明度
```



#### imread

imread() 方法是 Matplotlib 库中的一个函数，用于从图像文件中读取图像数据。可以裁剪图像，也可以改变图像的颜色。

imread() 方法返回一个 numpy.ndarray 对象，其形状是 **(nrows, ncols, nchannels)**，表示读取的图像的行数、列数和通道数：

- 如果图像是灰度图像，则 nchannels 为 1。
- 如果是彩色图像，则 nchannels 为 3 或 4，分别表示红、绿、蓝三个颜色通道和一个 alpha 通道。

imread() 方法的语法如下：

```
matplotlib.pyplot.imread(fname, format=None)
fname：指定了要读取的图像文件的文件名或文件路径，可以是相对路径或绝对路径。
format ：参数指定了图像文件的格式，如果不指定，则默认根据文件后缀名来自动识别格式。
```

```py
import matplotlib.pyplot as plt

# 读取图像文件，下载地址：
img = plt.imread('map.jpeg')

# 显示图像
plt.imshow(img)
plt.show()
```

#### ciscn2023的国粹

根据第一张麻将的图片进行从1开始标记，然后以a.png为横坐标，另一个为纵坐标。

```py

import matplotlib.pyplot as plt
x = [1,1,1,1,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,10,10,12,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,31,31,31,31,31,31,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,33,33,33,33,33,33,33,33,33,33,33,34,34,34,34,34,34,34,34,34,35,35,35,35,35,35,35,35,35,35,35,36,36,36,36,36,36,36,37,37,37,37,37,37,37,37,37,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,39,39,39]
y = [4,5,10,10,30,3,4,5,6,10,29,30,3,4,10,16.17,22,23,24,25,29,30,2,3,4,5,10,15,16,18,21,22,24,25,29,30,3,4,10,15,17,18,19,21,22,25,28,29,3,4,10,15,16,18,19,21,22,25,29,34,10,11,12,13,15,18,19,22,23,24,25,29,30,3,4,11,12,15,16,17,18,19,20,25,29,30,20,21,23,24,30,31,22,24,22,23,24,25,2,3,3,4,9,10,11,12,16,17,18,19,24,25,2,5,6,9,12,18,22,23,5,9,12,18,19,22,23,4,5,9,12,17,18,23,24,3,4,9,12,16,17,24,25,3,9,12,16,25,3,4,5,6,9,10,11,12,16,17,18,19,21,22,23,24,25,10,11,3,4,5,6,10,11,12,17,18,19,24,25,3,6,7,9,10,16,17,19,20,22,23,24,25,3,6,7,9,10,15,18,19,23,24,3,6,7,10,11,12,16,19,20,24,25,3,6,7,12,13,16,19,20,24,25,3,6,7,9,12,13,16,19,20,24,25,3,4,6,9,10,11,12,16,17,19,20,24,25,4,5,17,18,19,10,11,12,13,25,31,4,5,6,10,11,12,13,17,18,19,23,24,25,26,32,3,4,5,6,7,12,16,17,23,24,26,32,6,7,11,16,17,23,24,26,32,6,11,12,17,18,19,23,24,25,26,33,5,12,13,19,20,26,32,4,5,13,16,19,20,25,26,32,4,5,6,7,9,10,11,12,13,16,17,18,19,24,25,31,32,23,24,31]

plt.plot(x,y,'rH')
plt.show()
```

绘图得到

![Figure_1](C:\Users\86157\Desktop\新建文件夹\国粹_2565d1d59a016751a3dcf845311e7346\Figure_1.png)



flag{202305012359}

#### [CISCN 2021初赛]robot

打开流量包，发现都是TCP，追踪TCP流发现了类似正则表达的东西。tgPos{74}.Value.[24,44,0]

很明显最后面的是一个坐标。

strings -a cap.pcapng |grep "\[.*\]"     #(匹配[]内的任何字符)

导出得发现最后一个坐标基本都是0.

猜测前两位为x，y

```py
import matplotlib.pyplot as plt
import numpy as np
import matplotlib as mpl
import ast

file = open("tcp.txt", "r")

for line in file.readlines():
    s = ast.literal_eval(line)  //能够避免产生安全风险
    x = s[0]
    y = s[1]
    plt.plot(x, y, '*', label='data', color='black')

plt.legend()
plt.show()
```

修改txt文件使其能转换为python对象。

得到

![Figure_1](C:\Users\86157\Desktop\新建文件夹\robot_5324b1f2bef88a5b28bca0f1d3ba6afc(2)\Figure_1.png)

然后倒置再md5得到结果。

### tshark

#### 常用操作

```
 1.tshark -D     //查看有哪些设备

2. tshark -i      //参数指定需要抓包的设备

3. tshark -f     // 默认的过滤器，所以一般不带这个参数也是可以的。

 4.tshark-r 提取如wireshark表格中显示的封包摘要信息

5. tshark-Y   //使用filter过滤器.表达式支持更加细粒度的过滤，例如http.request.url或者mysql.query等等。
  1. mysql协议：https://www.wireshark.org/docs/dfref/m/mysql.html
  2. HTTP协议：https://www.wireshark.org/docs/dfref/h/http.html

6. tshark-T   //指出解析时输出的格式 
       默认text 
       fields (需要增加-e参数)
       其他选项 ek|json|jsonraw|pdml|ps|psml|tabs

  获取SQL语句  tshark -Y 'mysql.query' -T fields -e mysql.query

7.tshark-e 指定一个字段

8.tshark …… >1.txt  //重定向

9.tshark -c`:指定停止条件

tshark -c 1:抓一个包就停止

10.tshark -w`:-w选项后可以接路径和文件名，保存到文件，默认按照cap格式保存。另外指定-T参数之后无法再使用-w，请注意。
11.tshark-V 将packet展开查看详情,如输入tshark -c 1 -V
转换数据包格式
tshark  -r  数据包路径  -w  另存为路径  -F  数据包格式
12.统计会话
tshark -r C:\Users\25348\Desktop\test.pcap -z conv,ip -q
13.统计数据包信息
tshark -r C:\Users\25348\Desktop\test.pcap -z ptype,tree -q
常用方法：tshark -r **.pcap –Y ** -T fields –e ** | **** > data
```

+ r evidence.pcap 需要分析的报文记录文件（pcap格式）

- -T fields 输出格式，选fields按字段，也可以选json等其他格式，需结合-e 及 -E使用                                     
- -e frame.time_relative 取出封包的相对时间
- -e ip.src 提取源IP
- -e ip.dst 提取目的IP
- -e ip.proto 提取协议名
- -e tcp.srcport 提取源Port
- -e tcp.dstport 提取目的Port
- -e frame.len 提取数据帧大小
- -E header=n 是否输出字段名称（cvs的第1行）
- -E separator=, 指定分割符，/t是tab，/s是一格空格
- -E quote=n 指定是否对字段用引号，d是双引号，s是单引号，n是不用
- -E occurrence=f 多值时是否保留，f是第一个值，l是最后一个值，a是所有值都列出，默认全部
- output.csv 输出文件路径及名称

#### 使用案例

```python
//打印http协议流相关信息
tshark -s 512 -i eth0 -n -f 'tcp dst port 80' -R 'http.host and http.request.uri' -T fields -e http.host -e http.request.uri -l | tr -d '\t'
　　注释：
　　　　-s: 只抓取前512字节；
　　　　-i: 捕获eth0网卡；
　　　　-n: 禁止网络对象名称解析;
　　　　-f: 只捕获协议为tcp,目的端口为80;
　　　　-R: 过滤出http.host和http.request.uri;
　　　　-T,-e: 指的是打印这两个字段;
　　　　-I: 输出到命令行界面; 
//实时打印当前mysql查询语句
tshark -s 512 -i eth0 -n -f 'tcp dst port 3306' -R 'mysql.query' -T fields -e mysql.query
　　　注释:
　　　　-R: 过滤出mysql的查询语句;
//导出smpp协议header和value的例子
tshark -r test.cap -R '(smpp.command_id==0x80000004) and (smpp.command_status==0x0)' -e smpp.message_id -e frame.time -T fields -E header=y >test.txt
　　　注释:
　　　　-r: 读取本地文件，可以先抓包存下来之后再进行分析;
　　　　-R: smpp...可以在wireshark的过滤表达式里面找到，后面会详细介绍;
　　　　-E: 当-T字段指定时，设置输出选项，header=y意思是头部要打印;
　　　　-e: 当-T字段指定时，设置输出哪些字段;
　　　　 >: 重定向;
//统计http状态
tshark -n -q -z http,stat, -z http,tree
　　　注释:
　　　　-q: 只在结束捕获时输出数据，针对于统计类的命令非常有用;
　　　　-z: 各类统计选项，可以使用tshark -z help命令来查看所有支持的字段;
　　　　　　 http,stat: 计算HTTP统计信息，显示的值是HTTP状态代码和HTTP请求方法。
　　　　　　 http,tree: 计算HTTP包分布。 显示的值是HTTP请求模式和HTTP状态代码。
//抓取500个包提取访问的网址打印出来
tshark -s 0 -i eth0 -n -f 'tcp dst port 80' -R 'http.host and http.request.uri' -T fields -e http.host -e http.request.uri -l -c 500
　　　注释: 
　　　　-f: 抓包前过滤；
　　　　-R: 抓包后过滤；
　　　　-l: 在打印结果之前清空缓存;
　　　　-c: 在抓500个包之后结束;
//显示ssl data数据
tshark -n -t a -R ssl -T fields -e "ip.src" -e "ssl.app_data"
 
//读取指定报文,按照ssl过滤显示内容
tshark -r temp.cap -R "ssl" -V -T text
　　注释: 
　　　　-T text: 格式化输出，默认就是text;
　　　　-V: 增加包的输出;//-q 过滤tcp流13，获取data内容
tshark -r temp.cap -z "follow,tcp,ascii,13"
 
//按照指定格式显示-e
tshark -r temp.cap -R ssl -Tfields -e "ip.src" -e tcp.srcport -e ip.dst -e tcp.dstport
 
//输出数据
tshark -r vmx.cap -q -n -t ad -z follow,tcp,ascii,10.1.8.130:56087,10.195.4.41:446 | more
　　注释:
　　　　-t ad: 输出格式化时间戳;
//过滤包的时间和rtp.seq
tshark  -i eth0 -f "udp port 5004"  -T fields -e frame.time_epoch -e rtp.seq -o rtp.heuristic_rtp:true 1>test.txt
　　注释:
　　　　-o: 覆盖属性文件设置的一些值;
 
//提取各协议数据部分
tshark -r H:/httpsession.pcap -q -n -t ad -z follow,tcp,ascii,71.6.167.142:27017,101.201.42.120:59381 | more
// USB协议数据部分在Leftover Capture Data域中，使用tshark命令将其单独提取出来
tshark -r udn.pcapng -T fields -e usb.capdata > usbdata.txt
```



#### [CISCN 2022 初赛]ez_usb

```py
tshark -r "C:\Users\86157\Desktop\新建文件夹\新建文件夹\ez_usb.pcapng" -Y 'usb.data_len == 8' -Y 'usb.src =="2.10.1"' -T fields -e usbhid.data > 3.txt
```

```py
tshark -r "C:\Users\86157\Desktop\新建文件夹\新建文件夹\ez_usb.pcapng" -Y 'usb.data_len == 8' -Y 'usb.src =="2.8.1"' -T fields -e usbhid.data > 1.txt
```

```
tshark -r ez_usb.pcapng -Y "usb.src==\"2.8.1\"" -T fields -e usb.capdata > usb.dat
```

或者使用wireshark先导出特定分组，然后再tshark提取数据并去除空行

 tshark -r 2.8.1.pcapng -Y usb.capdata -T fields -e usb.capdata > 1.txt
（导出特定分组后，hid就变成Leftover Capture Data）

然后使用脚本解出键盘流量然后转化为16进制

得到一个rar文件一个密码。

526172211a0700cf907300000d00000000000000c4527424943500300000002a00000002b9f9b0530778b5541d33080020000000666c61672e747874b9ba013242f3afc000b092c229d6e994167c05a78708b271ffc042ae3d251e65536f9ada87c77406b67d0e6316684766a86e844dc81aa2c72c71348d10c43d7b00400700



35c535765e50074a



flag{20de17cc-d2c1-4b61-bebd-41159ed7172d}

